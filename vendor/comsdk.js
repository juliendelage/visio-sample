!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.ComSDK=t():e.ComSDK=t()}(this,function(){return function(e){function t(o){if(n[o])return n[o].exports;var i=n[o]={exports:{},id:o,loaded:!1};return e[o].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){"use strict";var o=n(15)["default"],i=n(14)["default"],c=n(1)["default"];Object.defineProperty(t,"__esModule",{value:!0});var r=n(7),a=(c(r),n(2)),d=c(a),s=n(8),l=c(s),u=n(9),f=c(u),m=n(10),b=c(m),h=n(12),v=c(h),g=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?"http://webcom.orange.com/base/webrtc":arguments[0];i(this,e),this.datarefs=l["default"](t),this.webrtcmngr=v["default"](this.datarefs)}return o(e,[{key:"Room",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return b["default"].apply(void 0,t.concat([this.datarefs,this.webrtcmngr]))}},{key:"Reach",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return f["default"].apply(void 0,t.concat([this.datarefs]))}}],[{key:"version",get:function(){return"0.0.1"}},{key:"actions",get:function(){return d["default"]}}]),e}();t["default"]=g,e.exports=t["default"]},function(e,t){"use strict";t["default"]=function(e){return e&&e.__esModule?e:{"default":e}},t.__esModule=!0},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t["default"]={ACTION_TYPE_AUDIO:"audio",ACTION_TYPE_VIDEO:"video",ACTION_TYPE_CHAT:"chat",ACTION_TYPE_AUDIO_VIDEO:"audio-video",ACTION_TYPE_SCREEN_SHARING:"screen-sharing",ACTION_TYPE_CALL:"call"},e.exports=t["default"]},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e){if(console.log("(webcomSDK::localstream::initVideo)"),!v)if(v=!0,navigator.getMedia=getUserMedia,m=document.createElement("VIDEO"),m.muted=!0,i.push(m),null===a)navigator.getMedia({audio:!1,video:!0},function(t){a=t;for(var n=0;n<i.length;n++)attachMediaStream(i[n],a);i=[];for(var o=0;o<l.length;o++)l[o](a);l=[],v=!1,e&&e()},function(t){console.error("Error on webrtcLocalStream - webkitGetUserMedia : error="),console.dir(t),v=!1,e&&e(t)});else{for(var t=0;t<i.length;t++)attachMediaStream(i[t],a);i=[];for(var n=0;n<l.length;n++)l[n](a);l=[],v=!1}}function t(e){if(console.log("(webcomSDK::localstream::initAudio)"),!g)if(g=!0,navigator.getMedia=getUserMedia,b=document.createElement("AUDIO"),b.muted=!0,c.push(b),null===d)navigator.getMedia({audio:!0,video:!1},function(t){d=t;for(var n=0;n<c.length;n++)attachMediaStream(c[n],d);c=[];for(var o=0;o<u.length;o++)u[o](d);u=[],g=!1,e&&e()},function(t){console.error("Error on webrtcLocalStream - webkitGetUserMedia :error="),console.dir(t),g=!1,e&&e(t)});else{for(var t=0;t<c.length;t++)attachMediaStream(c[t],d);c=[];for(var n=0;n<u.length;n++)u[n](d);u=[],g=!1}}function n(e){if(console.log("(webcomSDK::localstream::initAudioVideo)"),!p)if(p=!0,navigator.getMedia=getUserMedia,h=document.createElement("AUDIOVIDEO"),h.muted=!0,r.push(h),null===s)navigator.getMedia({audio:!0,video:!0},function(t){s=t;for(var n=0;n<r.length;n++)attachMediaStream(r[n],s);r=[];for(var o=0;o<f.length;o++)f[o](s);f=[],p=!1,e&&e()},function(t){console.error("(webcomSDK::localstream::initAudioVideo::Error on webrtcLocalStream - webkitGetUserMedia : error="),console.dir(t),p=!1,e&&e(t)});else{for(var t=0;t<r.length;t++)attachMediaStream(r[t],s);r=[];for(var n=0;n<f.length;n++)f[n](s);f=[],p=!1}}function o(){console.log("(webcomSDK::localstream::close)"),m&&(detachMediaStream(m),m=null),s&&(s.stop(),s=null),a&&(a.stop(),a=null),v=!1,b&&(detachMediaStream(b),b=null),d&&(d.stop(),d=null),g=!1,h&&(detachMediaStream(h),h=null),s&&(s.stop(),s=null),p=!1}var i=[],c=[],r=[],a=null,d=null,s=null,l=[],u=[],f=[],m=null,b=null,h=null,v=!1,g=!1,p=!1;return{getVideoStream:function(){return a},addVideoListener:function(e){l.push(e)},initVideo:function(){e()},connectLocalVideoStream:function(t,n,o){t?(t.muted=!0,a?(console.log("(webcomSDK::localstream::connectLocalVideoStream)use existing streamVideo"),attachMediaStream(t,a),o&&"function"==typeof o&&o(a)):(i.push(t),o&&"function"==typeof o&&l.push(o),e(n))):a?o&&"function"==typeof o&&o(a):(o&&"function"==typeof o&&l.push(o),e(n))},getAudioStream:function(){return d},addAudioListener:function(e){u.push(e)},initAudio:function(){t()},connectLocalAudioStream:function(e,n,o){e?(e.muted=!0,d?(console.log("(webcomSDK::localstream::connectLocalAudioStream)use existing streamAudio"),attachMediaStream(e,d),o&&"function"==typeof o&&o(d)):(c.push(e),o&&"function"==typeof o&&u.push(o),t(n))):d?o&&"function"==typeof o&&o(d):(o&&"function"==typeof o&&u.push(o),t(n))},getAudioVideoStream:function(){return s},addAudioVideoListener:function(e){f.push(e)},initAudioVideo:function(){n()},connectLocalAudioVideoStream:function(e,t,o){e?(e.muted=!0,s?(console.log("(webcomSDK::localstream::connectLocalAudioVideoStream)use existing streamAudioVideo"),attachMediaStream(e,s),o&&o(s)):(r.push(e),o&&"function"==typeof o&&f.push(o),n(t))):s?o&&o(s):(o&&"function"==typeof o&&f.push(o),n(t))},close:function(){o()}}}();t["default"]=n,e.exports=t["default"]},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}var t=function(){return""+e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}();return{appInstanceId:t}}();t["default"]=n,e.exports=t["default"]},function(e,t){var n=e.exports={};"number"==typeof __e&&(__e=n)},function(e,t,n){e.exports={"default":n(17),__esModule:!0}},function(e,t){"use strict";function n(e){e.hasOwnProperty("urls")&&(e.url=e.urls,delete e.urls),e.hasOwnProperty("url")&&e.url.toLowerCase().startsWith("turns")&&navigator.mozGetUserMedia&&console.warn("(webcomSDK::maybeFixConfiguration) turns detected on firefox -> ignore this entry")}function o(e){if(null!==e&&e.iceServers&&e.iceServers.length>0){for(var t=[],o=e.iceServers.length-1;o>=0;o--){var i=e.iceServers[o];n(i),t.push(i)}e.iceServers=t}}function i(e,t,n){var o=arguments.length<=3||void 0===arguments[3]?!1:arguments[3],i=void 0;if(o){var c=e.split("?");(1===c.length||0===c[1].indexOf("transport=udp"))&&(i={url:c[0],credential:n,username:t})}else i={url:e,credential:n,username:t};return i}if(window.RTCPeerConnection=null,window.getUserMedia=null,window.attachMediaStream=null,window.reattachMediaStream=null,window.webrtcDetectedBrowser=null,window.webrtcDetectedVersion=null,navigator.mozGetUserMedia)window.webrtcDetectedBrowser="firefox",window.webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10),window.RTCPeerConnection=function(e,t){return o(e),new mozRTCPeerConnection(e,t)},window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=mozRTCIceCandidate,window.getUserMedia=navigator.mozGetUserMedia.bind(navigator),navigator.getUserMedia=getUserMedia,window.createIceServer=function(e,t,n){var o=null,c=e.split(":");return 0===c[0].indexOf("stun")?o={url:e}:0===c[0].indexOf("turn")&&(o=i(e,t,n,window.webrtcDetectedVersion<27)),o},window.createIceServers=function(e,t,n){for(var o=[],i=0;i<e.length;i++){var c=window.createIceServer(e[i],t,n);null!==c&&o.push(c)}return o},window.detachMediaStream=function(e){e&&(e.mozSrcObject=null,e.pause())},window.attachMediaStream=function(e,t){try{e&&t?(e.mozSrcObject=t,e.play&&"function"==typeof e.play?e.play():console.warn("(webcomSDK::attachMediaStream)element.play not available")):console.error("webcomSDK::attachMediaStream->parameters not valid")}catch(n){console.error("(webcomSDK::attachMediaStream)Exception="+n)}},window.reattachMediaStream=function(e,t){e&&t?(e.mozSrcObject=t.mozSrcObject,e.play()):console.error("webcomSDK::reattachMediaStream->parameters not valid")},MediaStream.prototype.getVideoTracks||(MediaStream.prototype.getVideoTracks=function(){return[]}),MediaStream.prototype.getAudioTracks||(MediaStream.prototype.getAudioTracks=function(){return[]});else{if(!navigator.webkitGetUserMedia)throw new Error("Browser does not appear to be WebRTC-capable");window.webrtcDetectedBrowser="chrome",window.webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2],10),window.createIceServer=function(e,t,n){var o=null,c=e.split(":");return 0===c[0].indexOf("stun")?o={url:e}:0===c[0].indexOf("turn")&&(o=i(e,n,t)),o},window.createIceServers=function(e,t,n){var o=[];if(window.webrtcDetectedVersion>=34)o={urls:e,credential:n,username:t};else for(var i=0;i<e.length;i++){var c=window.createIceServer(e[i],t,n);null!==c&&o.push(c)}return o},window.RTCPeerConnection=function(e,t){return window.webrtcDetectedVersion<34&&o(e),new webkitRTCPeerConnection(e,t)},window.getUserMedia=navigator.webkitGetUserMedia.bind(navigator),navigator.getUserMedia=getUserMedia,window.attachMediaStream=function(e,t){try{e&&t?(e.src=URL.createObjectURL(t),e.autoplay=!0):console.error("webcomSDK::attachMediaStream ->parameters not valid")}catch(n){console.error("(webcomSDK::attachMediaStream)Exception="+n)}},window.detachMediaStream=function(e){e&&("undefined"!=typeof e.srcObject?e.srcObject="":"undefined"!=typeof e.mozSrcObject?e.mozSrcObject="":"undefined"!=typeof e.src?e.src="":console.log("Error attaching stream to element."))},window.reattachMediaStream=function(e,t){e&&t?e.src=t.src:console.error("webcomSDK::reattachMediaStream media stream->parameters not valid")}}},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t["default"]=function(e){function t(){h=b.child("roomsList"),v=b.child("reach"),g=b.child("webrtc"),p=b.child("sipPhoneNumbers")}function n(e){b=new Webcom(e),t()}function o(){return b?b.toString():void 0}function i(e){b=e,t()}function c(){return b}function r(e){h=e}function a(){return h}function d(e){v=e}function s(){return v}function l(e){g=e}function u(){return g}function f(e){p=e}function m(){return p}var b=null,h=null,v=null,g=null,p=null;return function(){b=new Webcom(e),t()}(),{setWebcomBaseUrl:function(e){return n(e)},getWebcomBaseUrl:function(){return o()},setDatastore:function(e){return i(e)},getDatastore:function(){return c()},setRooms:function(e){return r(e)},getRooms:function(){return a()},setReach:function(e){return d(e)},getReach:function(){return s()},setWebrtc:function(e){return l(e)},getWebrtc:function(){return u()},setSipPhoneNumbers:function(e){return f(e)},getSipPhoneNumbers:function(){return m()}}},e.exports=t["default"]},function(e,t,n){"use strict";var o=n(6)["default"],i=n(1)["default"];Object.defineProperty(t,"__esModule",{value:!0});var c=n(4),r=i(c),a="ONGOING",d="REJECTED",s="CANCELED",l="OPEN",u=function(e,t){function n(e,t){console.log("(webcomSDK::reach::_isConnected)userId"+e);var n=function(e){var n=null!==e.val();t&&"function"==typeof t&&t(n)};K.child("userList").child(e).child("connectedList").once("value",n)}function i(e,t){console.log("(webcomSDK::reach::_isRegistered)userId"+e);var n=function(e){var n=null!==e.val();t&&"function"==typeof t&&t(n)};K.child("userList").child(e).child("wasInsideReach").once("value",n)}function c(e){P&&P.child("status").set(e)}function u(e){A&&(K.child("userList").off("child_added",A),A=null),e&&"function"==typeof e&&(A=function(t){console.log("(webcomSDK::reach::onUserAddedCb)"+t.name()+"="+JSON.stringify(t.val()));var n={};n[t.name()]=t.val(),e(n)},K.child("userList").on("child_added",A))}function f(e){C&&(K.child("userList").off("child_changed",C),C=null),e&&"function"==typeof e&&(C=function(t){console.log("(webcomSDK::reach::onUserChangedCb)"+t.name()+"="+JSON.stringify(t.val()));var n={};n[t.name()]=t.val(),e(n)},K.child("userList").on("child_changed",C))}function m(e){O&&(K.child("userList").off("child_removed",O),O=null),e&&"function"==typeof e&&(O=function(t){console.log("(webcomSDK::reach::onUserRemovedCb)"+t.name()+"="+JSON.stringify(t.val()));var n={};n[t.name()]=t.val(),e(n)},K.child("userList").on("child_removed",O))}function b(e){M&&(K.child("invitationList").child(k).off("child_added",M),M=null),e&&"function"==typeof e&&(M=function(t){if(t.val().status===a){console.log("(webcomSDK::reach::_setOnNewRoomInvitation)new Invite received,id)"+t.name()+",content="+JSON.stringify(t.val()));var n=t.name();R||(R=[]),R[n]&&(R[n].timeout&&clearTimeout(R[n].timeout),delete R[n]),R[n]={};var o={};if(o[n]=t.val(),e(o),E){var i=setTimeout(function(){E&&(console.log("(webcomSDK::reach::_setOnNewRoomInvitation)automatic reject of Invite received="+JSON.stringify(t.val())),K.child("invitationList").child(k).child(n).onDisconnect().cancel(),V?K.child("invitationList").child(k).child(n).update({timestamp_end:Webcom.ServerValue.TIMESTAMP,status:d,status_info:V}):K.child("invitationList").child(k).child(n).update({timestamp_end:Webcom.ServerValue.TIMESTAMP,status:d}))},E);R[n].timeout=i}var c=function(e){e&&"status"===e.name()&&e.ref().parent().once("value",function(t){var n,o;if(t){n=e.ref().parent().name(),o=t.val();var i={};i[n]=o,R&&R[n]&&R[n].timeout&&clearTimeout(R[n].timeout),console.log("(webcomSDK::reach::_setOnNewRoomInvitation)Invite changed,id=)"+n,"'new content="+JSON.stringify(o)),i&&L&&L(i),delete R[n]}})};K.child("invitationList").child(k).child(n).once("child_changed",c)}},K.child("invitationList").child(k).on("child_added",M))}function h(e){L&&(L=null),e&&"function"==typeof e&&(L=e)}function v(e,t){E&&(E=null),V&&(V=null),e&&e===parseInt(e,10)&&e>0&&(console.log("(webcomSDK::reach::_setNewRoomInvitationTimeout)timeout="+e),E=e),t&&(V=t)}function g(e,n,o){if(console.log("(webcomSDK::reach::_isUserPresentInRoom)p_roomId="+e+" p_user="+n),!e||"string"!=typeof e)return void console.error("(webcomSDK::reach::_isUserPresentInRoom)parameter p_roomid is incorrect. Expecting non empty string");if(!n||"string"!=typeof n)return void console.error("(webcomSDK::reach::_isUserPresentInRoom)parameter p_user is incorrect. Expecting non empty string");if(!o||"function"!=typeof o)return void console.error("(webcomSDK::reach::_isUserPresentInRoom)parameter p_cb is incorrect. if defined, expecting a function");var i=function(t){var i=null!==t.val();console.log("(webcomSDK::reach::_isUserPresentInRoom)p_roomId="+e+",p_user="+n+",result="+i),o(i,e,n)};t.getRooms().child(e).child("participantList").child(n).child("wasInsideRoom").once("value",i)}function p(e,n,o,i){if(!e||"string"!=typeof e)return void console.error("(webcomSDK::reach::inviteToRoom)parameter p_roomid is incorrect. Expecting non empty string");if(!o||"string"!=typeof o)return void console.error("(webcomSDK::reach::inviteToRoom)parameter p_topic is incorrect. Expecting non empty string");if(i&&"function"!=typeof i&&console.warn("(webcomSDK::reach::inviteToRoom)parameter p_statusChangedCb is incorrect. if defined, expecting a function"),!(n&&n instanceof Array))return void console.error("(webcomSDK::reach::inviteToRoom)parameter p_guestIds is incorrect. Expecting an Array");t.getRooms().child(e).child("commonDataList").update({status:l,owner:k});for(var c=function(e,n,o){e||t.getRooms().child(n).child("participantList").child(o).update({connected:!1,wasInsideRoom:!1})},r=function(t){if(console.log("(webcomSDK::reach::inviteToRoom::_InviteChangedCb)"),t&&"status"===t.name()){var n=t.ref().parent().parent().name();console.log("(webcomSDK::reach::inviteToRoom::_InviteChangedCb)cb_guestId2="+n),T&&T[e]&&T[e][n]&&T[e][n].InviteChangedCb&&T[e][n].InviteDataref.off("child_changed",T[e][n].InviteChangedCb),t.ref().parent().once("value",function(e){var t,n,o,i;e?(t=e.val().status,o=e.val().room,i=e.val().status_info,n=e.ref().parent().name(),console.log("(webcomSDK::reach::inviteToRoom::_InviteChangedCb)roomId="+o+" invitee="+n+" new invitation status="+t+" status info="+i),T&&T[o]&&T[o][n]&&T[o][n].InviteDataref?(T[o][n].InviteDataref.onDisconnect().cancel(),T[o][n].statusChangedCb&&"function"==typeof T[o][n].statusChangedCb?T[o][n].statusChangedCb(o,n,t,i):console.warn("(webcomSDK::reach::inviteToRoom::_InviteChangedCb)cannot retrieve mathing p_statusChangedCb"),delete T[o][n]):console.warn("(webcomSDK::reach::inviteToRoom::_InviteChangedCb)cannot retrieve mathing mOutgoingInvite")):console.warn("(webcomSDK::reach::inviteToRoom::_InviteChangedCb)cannot retrieve invitation")})}},d=0;d<n.length;d++){var u=n[d];if(u&&"string"==typeof u){if(console.log("(webcomSDK::reach::inviteToRoom)roomId="+e+" invitee="+u.toString()),T[e]&&T[e][u])return void S(e,[u],function(t){t&&t===u&&p(e,[t],o,i)});T[e]||(T[e]=[]),T[e][u]={},g(e,u,c),T[e][u].InviteDataref=K.child("invitationList").child(u).push({from:k,room:e,timestamp_creation:Webcom.ServerValue.TIMESTAMP,topic:o,status:a}),console.log("(webcomSDK::reach::inviteToRoom)InviteDataref="+T[e][u].InviteDataref.toString()),T[e][u].InviteChangedCb=r,T[e][u].InviteDataref.on("child_changed",T[e][u].InviteChangedCb),T[e][u].statusChangedCb=i,T[e][u].InviteDataref.onDisconnect().update({timestamp_end:Webcom.ServerValue.TIMESTAMP,status:s})}else console.error("(webcomSDK::reach::inviteToRoom)parameter p_guestIds["+d+"] is incorrect. Expecting non empty string")}}function S(e,t,n){if(!e||"string"!=typeof e)return void console.error("(webcomSDK::reach::_cancelInvitation)parameter p_roomid is incorrect. Expecting non empty string");if(t&&!t instanceof Array)return void console.error("(webcomSDK::reach::_cancelInvitation)parameter p_guestIds is incorrect. Expecting an Array");if(console.log("(webcomSDK::reach::_cancelInvitation)p_roomId="+e+",p_guestIds="+JSON.stringify(t)),T&&T[e])if(t)for(var o=0;o<t.length;o++){var i=t[o];i&&"string"==typeof i?T[e][i]?T[e][i].InviteDataref?(T[e][i].InviteDataref.onDisconnect().cancel(),T[e][i].InviteChangedCb&&"function"==typeof T[e][i].InviteChangedCb&&T[e][i].InviteDataref.off("child_changed",T[e][i].InviteChangedCb),T[e][i].InviteDataref.once("value",function(t){var o,c,r;t&&t.val()&&(o=t.val().status,r=t.val().room,c=t.ref().parent().name(),o&&o===a?(T[r][c].InviteDataref.update({timestamp_end:Webcom.ServerValue.TIMESTAMP,status:s}),T[r][c].statusChangedCb&&"function"==typeof T[r][c].statusChangedCb&&T[r][c].statusChangedCb(r,c,s),console.log("(webcomSDK::reach::_cancelInvitation)deleting Invite to room "+r+" for invitee "+c)):console.warn("(webcomSDK::reach::_cancelInvitation)cannot delete intivation to room "+r+" for guest "+c+" Invitation has been removed/rejected/accepted")),delete T[e][i],n&&"function"==typeof n&&n(i)})):(delete T[e][i],n&&"function"==typeof n&&n(i)):n&&"function"==typeof n&&n(i):console.error("(webcomSDK::reach::inviteToRoom)parameter p_guestIds["+o+"] is incorrect. Expecting non empty string")}else for(var c in T[e])S(e,[c],n);else console.warn("(webcomSDK::reach::_cancelInvitation) Invite to room "+e+" not found")}function w(e){var t=o(e)[0];return t?e[t]?void K.child("invitationList").child(k).child(t).once("value",function(n){var o,i,c;n&&n.val()&&(c=n.name(),o=n.val().status,i=n.ref().parent().name(),o&&o===a?(console.log("(webcomSDK::reach::_acceptInvitation)inviteId="+t+",data="+JSON.stringify(e[t])),K.child("invitationList").child(i).child(c).update({timestamp_end:Webcom.ServerValue.TIMESTAMP,status:"ACCEPTED"})):console.warn("(webcomSDK::reach::_acceptInvitation)inviteId="+c+",data="+JSON.stringify(e[t])+", cannot be accepted. It has been removed or canceled"))}):void console.error("(webcomSDK::reach::_acceptInvitation)parameter p_invitation is incorrect. cannot get invitation data"):void console.error("(webcomSDK::reach::_acceptInvitation)parameter p_invitation is incorrect. cannot get invitation Id")}function _(e,t){var n=o(e)[0];return n?e[n]?void K.child("invitationList").child(k).child(n).once("value",function(o){var i,c,r;o&&o.val()&&(r=o.name(),i=o.val().status,c=o.ref().parent().name(),i&&i===a?(console.log("(webcomSDK::reach::_rejectInvitation)inviteId="+n+",data="+JSON.stringify(e[n])),t?K.child("invitationList").child(c).child(r).update({timestamp_end:Webcom.ServerValue.TIMESTAMP,status_info:t,status:d}):K.child("invitationList").child(c).child(r).update({timestamp_end:Webcom.ServerValue.TIMESTAMP,status:d})):console.warn("(webcomSDK::reach::_rejectInvitation)inviteId="+r+",data="+JSON.stringify(e[n])+", cannot be rejected. It has been removed or canceled"))}):void console.error("(webcomSDK::reach::_rejectInvitation)parameter p_invitation is incorrect. cannot get invitation data"):void console.error("(webcomSDK::reach::_rejectInvitation)parameter p_invitation is incorrect. cannot get invitation Id")}function I(e,t){console.log("(webcomSDK::reach::_archiveInvitations)userId="+e),K.child("invitationList").child(k).once("value",function(n){if(n&&n.hasChildren()){var o=n.numChildren(),i=0;n.forEach(function(n){if(n&&n.val())if(console.log("(webcomSDK::reach::_archiveInvitations)userId="+e+" inviteId="+n.name()),n.val().status===d||n.val().status===s)K.child("invitationListHistory").child(e).child(n.name()).update(n.val()),n.ref().remove(),i++,i>=o&&t&&"function"==typeof t&&t();else{var c={};c[n.name()]=n.val();var r=function(c){if(c)i++,i>=o&&t&&"function"==typeof t&&t();else{if(n.val().status===a){var r=n.val();r.status=s,K.child("invitationListHistory").child(e).child(n.name()).set(r)}else K.child("invitationListHistory").child(e).child(n.name()).set(n.val());n.ref().remove(),i++,i>=o&&t&&"function"==typeof t&&t()}};D(c,r)}else t&&"function"==typeof t&&t()})}else t&&"function"==typeof t&&t()})}function D(e,n){if(e&&n&&"function"==typeof n){var i=o(e)[0];console.log("(webcomSDK::reach::_isRoomActive)inviteId="+i);var c=e[i].room,r=function(e){e&&e.val()&&e.val()===l?(console.log("(webcomSDK::reach::_isRoomActive)inviteId="+i+" result=true"),n(!0)):(console.log("(webcomSDK::reach::_isRoomActive)inviteId="+i+" result=false"),n(!1))};t.getRooms().child(c).child("commonDataList").child("status").once("value",r)}}function y(){console.log("(webcomSDK::reach::_close)"),M&&(K.child("invitationList").child(k).off("child_added",M),M=null),A&&(K.child("userList").off("child_added",A),A=null),C&&(K.child("userList").off("child_changed",C),C=null),O&&(K.child("userList").off("child_removed",O),O=null),T&&(T.forEach(function(e){T[e].forEach(function(e){e.InviteDataref&&(e.InviteDataref.onDisconnect().cancel(),e.InviteDataref.update({status:s,timestamp_end:Webcom.ServerValue.TIMESTAMP}))})}),T=[]),E&&(E=null),V&&(V=null),P&&(P.remove(),P=null)}var k=e,K=t.getReach(),A=null,C=null,O=null,M=null,L=null,T=[],R=[],E=null,V=null,P=null;return function(){P=K.child("userList").child(k).child("connectedList").child(r["default"].appInstanceId),P.onDisconnect().remove(),P.child("status").set("CONNECTED");try{r["default"].appInstanceId&&P.child("description").child("appInstanceId").set(r["default"].appInstanceId),navigator.appCodeName&&P.child("description").child("navigator").child("appCodeName").set(navigator.appCodeName),navigator.appName&&P.child("description").child("navigator").child("appName").set(navigator.appName),navigator.appVersion&&P.child("description").child("navigator").child("appVersion").set(navigator.appVersion),navigator.buildID&&P.child("description").child("navigator").child("buildID").set(navigator.buildID),navigator.cookieEnabled&&P.child("description").child("navigator").child("cookieEnabled").set(navigator.cookieEnabled),navigator.language&&P.child("description").child("navigator").child("language").set(navigator.language),navigator.onLine&&P.child("description").child("navigator").child("onLine").set(navigator.onLine),navigator.oscpu&&P.child("description").child("navigator").child("onLine").set(navigator.oscpu),navigator.platform&&P.child("description").child("navigator").child("platform").set(navigator.platform),navigator.product&&P.child("description").child("navigator").child("product").set(navigator.product),navigator.productSub&&P.child("description").child("navigator").child("productSub").set(navigator.productSub),navigator.securityPolicy&&P.child("description").child("navigator").child("securityPolicy").set(navigator.securityPolicy),navigator.userAgent&&P.child("description").child("navigator").child("userAgent").set(navigator.userAgent),navigator.vendor&&P.child("description").child("navigator").child("vendor").set(navigator.vendor),navigator.vendorSub&&P.child("description").child("navigator").child("vendorSub").set(navigator.vendorSub)}catch(e){console.error("(webcomSDK::reach::init)failed to get information about device. error="+e)}K.child("userList").child(k).child("wasInsideReach").set(!0)}(),{getMe:function(){return k},isConnected:function(e,t){n(e,t)},isRegistered:function(e,t){i(e,t)},setConnectedStatus:function(e){return c(e)},setOnUserAdded:function(e){return u(e)},setOnUserChanged:function(e){return f(e)},setOnUserRemoved:function(e){return m(e)},inviteToRoom:function(e,t,n,o){return p(e,t,n,o)},cancelInvitation:function(e,t){return S(e,t)},setOnNewRoomInvitation:function(e){return b(e)},setOnRoomInvitationChanged:function(e){return h(e)},setNewRoomInvitationTimeout:function(e,t){return v(e,t)},archiveMyInvitations:function(e){return I(k,e)},acceptInvitation:function(e){return w(e)},rejectInvitation:function(e,t){return _(e,t)},on:function(e,t){switch(e){case"newRoomInvitation":this.setOnNewRoomInvitation(t);break;case"roomInvitationChanged":this.setOnRoomInvitationChanged(t);break;case"userAdded":this.setOnUserAdded(t);break;case"userChanged":this.setOnUserChanged(t);break;case"userRemoved":this.setOnUserRemoved(t);break;default:return console.error("reach.set: no such event"),-1}},close:function(){return y()}}};t["default"]=u,e.exports=t["default"]},function(e,t,n){"use strict";var o=n(6)["default"],i=n(1)["default"];Object.defineProperty(t,"__esModule",{value:!0});var c=n(2),r=i(c),a=n(3),d=i(a),s=n(4),l=i(s);t["default"]=function(e,t,n,i){function c(){j||(j=function(e){console.log("(webcomSDK::room["+L+"]::onPublishedStreamForAvailableStream)stream="+JSON.stringify(e.val()));var t={};t[e.name()]=e.val(),t[e.name()].roomId=L,D(t)},R.child("publishedMediaList").on("child_added",j)),Y||(Y=function(e){var t=e.name();console.log("(webcomSDK::room["+L+"]::onUnPublishedStreamForAvailableStream)stream="+t),y(t)},R.child("publishedMediaList").on("child_removed",Y))}function a(){return L}function s(){return T}function u(e){F&&(R.child("participantList").off("child_added",F),F=null),G&&(R.child("participantList").off("child_changed",G),G=null),e&&"function"==typeof e?(F=function(t){var n=t.name();t.val()&&t.val().connected&&t.val().wasInsideRoom&&(console.log("(webcomSDK::room["+L+"]::_setOnParticipantJoin) user has joined: "+n),e(n))},R.child("participantList").on("child_added",F),G=function(t){var n=t.name();t.val()&&t.val().connected&&t.val().wasInsideRoom&&(console.log("(webcomSDK::room["+L+"]::_setOnParticipantJoin) user has joined: "+n),e(n))},R.child("participantList").on("child_changed",G)):console.error("(webcomSDK::room["+L+"]::_setOnParticipantJoin)parameter incorrect. Expected function")}function f(e){z&&(R.child("participantList").off("child_changed",z),z=null),e&&"function"==typeof e?(z=function(t){var n=t.name();t.val()&&!t.val().connected&&t.val().wasInsideRoom&&(console.log("(webcomSDK::room["+L+"]::_setOnParticipantLeave) user has left: "+n),e(n))},R.child("participantList").on("child_changed",z)):console.error("(webcomSDK::room["+L+"]::_setOnParticipantLeave)parameter incorrect. Expected function")}function m(e){""!==e&&(console.log("(webcomSDK::room["+L+"]::sendInstantMessage)message="+e),R.child("instantMessageList").push({from:T,message:e,timestamp:Webcom.ServerValue.TIMESTAMP}))}function b(e){x&&(R.child("instantMessageList").off("child_added",x),x=null),e&&"function"==typeof e?(x=function(t){var n=t.val();console.log("(webcomSDK::room["+L+"]::_setOnInstantMessage)receive InstantMessage="+JSON.stringify(n)),e(n)},R.child("instantMessageList").on("child_added",x)):console.error("(webcomSDK::room["+L+"]::_setOnInstantMessage)parameter incorrect. Expected function")}function h(e,t,n,o){function c(){a.set({from:T,appInstanceId:l["default"].appInstanceId,actionType:n}),a.onDisconnect().remove();var o=function(o){var c=o.name(),r=o.val(),a=r.userId,d=r.peercoId,s=r.peercoRef;console.log("(webcomSDK::room["+L+"]::publishStream::addSubscribersListCb)subscriber "+a+" to stream "+e+" added "+JSON.stringify(r)),E[e+"_pub"]||(E[e+"_pub"]=[]);var l=!1,u=!1;W[e]&&W[e].audio&&(l=!0),W[e]&&W[e].video&&(u=!0);var f=i.createWebrtc(t,c,function(){console.log("(webcomSDK::room["+L+"]::publishStream::addSubscribersListCb)subscriber "+a+" to stream "+e+" connection lost")},!0,n,d,s,l,u);E[e+"_pub"].push({stackId:f,subscriberId:a,isPublish:!0,peercoId:d,peercoRef:s})},c=function(t){var n=t.name();if(n&&(console.log("(webcomSDK::room["+L+"]::publishStream::removeSubscribersListCb)subscriber "+n+" to stream "+e+" removed"),E[e+"_pub"]&&E[e+"_pub"].length>0)){for(var o=E[e+"_pub"].length-1;o>=0;o--)E[e+"_pub"][o].subscriberId===n&&i.closeWebrtc(E[e+"_pub"][o].stackId,!0);delete E[e+"_pub"]}};P[e]={addSubscribersListCb:o,removeSubscribersListCb:c},s.on("child_added",o),s.on("child_removed",c)}if(console.log("(webcomSDK::room["+L+"]::publishStream)roomId="+L+",streamId="+e+",me="+T+",actionType="+n),!e||"string"!=typeof e)return void console.error("(webcomSDK::reach::inviteToRoom)parameter streamId is incorrect. Expecting non empty string");var a=R.child("publishedMediaList").child(e),s=a.child("subscribersList");n&&(n===r["default"].ACTION_TYPE_VIDEO?d["default"].connectLocalVideoStream(t,c,o):n===r["default"].ACTION_TYPE_AUDIO?d["default"].connectLocalAudioStream(t,c,o):n===r["default"].ACTION_TYPE_AUDIO_VIDEO&&d["default"].connectLocalAudioVideoStream(t,c,o))}function v(e){U&&(R.child("publishedMediaList").off("child_added",U),U=null),e&&"function"==typeof e?(U=function(t){var n={};n[t.name()]=t.val(),n[t.name()].roomId=L,e(n)},R.child("publishedMediaList").on("child_added",U)):console.error("(webcomSDK::room["+L+"]::_setOnPublishedStream)parameter incorrect. Expected function")}function g(e,t){console.log("(webcomSDK::room["+L+"]::unPublishStream)streamId "+e);var n=R.child("publishedMediaList").child(e),o=n.child("subscribersList");if(P[e]&&P[e].addSubscribersListCb&&o.off("child_added",P[e].addSubscribersListCb),P[e]&&P[e].removeSubscribersListCb&&o.off("child_removed",P[e].removeSubscribersListCb),delete P[e],delete W[e],n.onDisconnect().cancel(),n.remove(),E[e+"_pub"]&&E[e+"_pub"].length>0)for(var c=E[e+"_pub"].length,r=c-1;r>=0;r--)i.closeWebrtc(E[e+"_pub"][r].stackId,!0,function(){c--,1>c&&(delete E[e+"_pub"],t&&"function"==typeof t&&t())});else delete E[e+"_pub"],t&&"function"==typeof t&&t()}function p(e){J&&(R.child("publishedMediaList").off("child_removed",J),J=null),e&&"function"==typeof e?(J=function(t){var n=t.name();e(n)},R.child("publishedMediaList").on("child_removed",J)):console.error("(webcomSDK::room["+L+"]::_setOnUnPublishedStream)parameter incorrect. Expected function")}function S(e,t,c){function a(e,t){return Math.floor(Math.random()*(t-e+1))+e}var s=o(e)[0],u=e[s].actionType;if(console.log("(webcomSDK::room["+L+"]::subscribeToStream)streamId "+s),P&&P[s])return u&&(u===r["default"].ACTION_TYPE_VIDEO?d["default"].connectLocalVideoStream(t,c):u===r["default"].ACTION_TYPE_AUDIO?d["default"].connectLocalAudioStream(t,c):u===r["default"].ACTION_TYPE_AUDIO_VIDEO&&d["default"].connectLocalAudioVideoStream(t,c)),s;var f=e[s].appInstanceId,m=R.child("publishedMediaList").child(s),b=m.child("subscribersList"),h=null,v=null;E[s+"_sub"]?E[s+"_sub"]&&E[s+"_sub"][0]&&E[s+"_sub"][0].peercoId&&(h=E[s+"_sub"][0].peercoId):E[s+"_sub"]=[],h||(h=Math.floor(Date.now()).toString()+a(0,1e6)),v=n.getWebrtc().push().name(),b.child(l["default"].appInstanceId).set({ts:Webcom.ServerValue.TIMESTAMP,userId:T,peercoId:h,peercoRef:v});var g=!1,p=!1;W[s]&&W[s].audio&&(g=!0),W[s]&&W[s].video&&(p=!0);var S=i.createWebrtc(t,f,function(){},!1,u,h,v,g,p,c);return N||(N=function(e){var t=o(e)[0];if(E[t+"_sub"]){for(var n=0;n<E[s+"_sub"].length;)i.closeWebrtc(E[s+"_sub"][n].stackId,!1),
n++;delete E[t+"_sub"]}},R.child("publishedMediaList").on("child_removed",N)),E[s+"_sub"].push({stackId:S,isPublish:!1,peercoId:h,peercoRef:v}),s}function w(e){console.log("(webcomSDK::room["+L+"]::unSubscribeFromStream)streamId "+e);var t=R.child("publishedMediaList").child(e),n=t.child("subscribersList");if(n.child(l["default"].appInstanceId).remove(),E[e+"_sub"]){for(var o=0;o<E[e+"_sub"].length;)E[e+"_sub"][o]&&i.closeWebrtc(E[e+"_sub"][o].stackId,!1),o++;delete E[e+"_sub"]}delete W[e]}function _(){return console.log("(webcomSDK::room["+L+"]::_getAvailableStreams)"),V}function I(e){if(console.log("(webcomSDK::room["+L+"]::_getAvailableStream)streamId="+e),V&&e)for(var t=V.length-1;t>=0;t--)if(V[t]&&o(V[t])[0]&&o(V[t])[0]===e)return V[t];return null}function D(e){console.log("(webcomSDK::room["+L+"]::_addAvailableStream)data="+JSON.stringify(e)),V.push(e)}function y(e){if(console.log("(webcomSDK::room["+L+"]::_removeAvailableStream)streamId="+e),V&&e)for(var t=V.length-1;t>=0;t--)V[t]&&o(V[t])[0]&&o(V[t])[0]===e&&delete V[t]}function k(){console.log("(webcomSDK::room["+L+"]::_removeAllAvailableStreams"),V=[]}function K(e){if(!e||"string"!=typeof e)return void console.error("(webcomSDK::room["+L+"]::_muteAudioStream)parameter streamId is incorrect. Expecting non empty string");if(console.log("(webcomSDK::room["+L+"]::_muteAudioStream)streamId="+e),W[e]||(W[e]={}),W[e].audio=!0,E&&E[e+"_pub"]&&E[e+"_pub"].length>0)for(var t=E[e+"_pub"].length-1;t>=0;t--)i.muteAudioWebrtcStack(E[e+"_pub"][t].stackId);if(E&&E[e+"_sub"]&&E[e+"_sub"].length>0)for(var t=E[e+"_sub"].length-1;t>=0;t--)i.muteAudioWebrtcStack(E[e+"_sub"][t].stackId)}function A(e){if(!e||"string"!=typeof e)return void console.error("(webcomSDK::room["+L+"]::_unmuteAudioStream)parameter streamId is incorrect. Expecting non empty string");if(W[e]&&W[e].audio&&(W[e].audio=!1),console.log("(webcomSDK::room["+L+"]::_unmuteAudioStream)streamId="+e),E&&E[e+"_pub"]&&E[e+"_pub"].length>0)for(var t=E[e+"_pub"].length-1;t>=0;t--)i.unmuteAudioWebrtcStack(E[e+"_pub"][t].stackId);if(E&&E[e+"_sub"]&&E[e+"_sub"].length>0)for(var t=E[e+"_sub"].length-1;t>=0;t--)i.unmuteAudioWebrtcStack(E[e+"_sub"][t].stackId)}function C(e){if(!e||"string"!=typeof e)return void console.error("(webcomSDK::room["+L+"]::_muteVideoStream)parameter streamId is incorrect. Expecting non empty string");if(console.log("(webcomSDK::room["+L+"]::_muteVideoStream)streamId="+e),W[e]||(W[e]={}),W[e].video=!0,E&&E[e+"_pub"]&&E[e+"_pub"].length>0)for(var t=E[e+"_pub"].length-1;t>=0;t--)i.muteVideoWebrtcStack(E[e+"_pub"][t].stackId);if(E&&E[e+"_sub"]&&E[e+"_sub"].length>0)for(var t=E[e+"_sub"].length-1;t>=0;t--)i.muteVideoWebrtcStack(E[e+"_sub"][t].stackId)}function O(e){if(!e||"string"!=typeof e)return void console.error("(webcomSDK::room["+L+"]::_unmuteVideoStream)parameter streamId is incorrect. Expecting non empty string");if(W[e]&&W[e].video&&(W[e].video=!1),console.log("(webcomSDK::room["+L+"]::_unmuteVideoStream)streamId="+e),E&&E[e+"_pub"]&&E[e+"_pub"].length>0)for(var t=E[e+"_pub"].length-1;t>=0;t--)i.unmuteVideoWebrtcStack(E[e+"_pub"][t].stackId);if(E&&E[e+"_sub"]&&E[e+"_sub"].length>0)for(var t=E[e+"_sub"].length-1;t>=0;t--)i.unmuteVideoWebrtcStack(E[e+"_sub"][t].stackId)}function M(e){console.log("(webcomSDK::room["+L+"]::_close)room "+L+", detroyRoom="+e),R.child("participantList").child(T).child("connected").set(!1);for(var t in P)g(t);P=[],x&&(R.child("instantMessageList").off("child_added",x),x=null),U&&(R.child("publishedMediaList").off("child_added",U),U=null),j&&(R.child("publishedMediaList").off("child_added",j),j=null),J&&(R.child("publishedMediaList").off("child_removed",J),J=null),Y&&(R.child("publishedMediaList").off("child_removed",Y),Y=null),F&&(R.child("participantList").off("child_added",F),F=null),G&&(R.child("participantList").off("child_changed",G),G=null),z&&(R.child("participantList").off("child_changed",z),z=null),N&&(R.child("publishedMediaList").off("child_removed",N),N=null);for(var n in E)for(var o=0;o<E[n].length;o++)E[n][o]&&(E[n][o].isPublish?i.closeWebrtc(E[n][o].stackId,!0):i.closeWebrtc(E[n][o].stackId,!1),i.clearWebrtcStacks(E[n][o].stackId));E={},W=[],k(),e&&e===!0&&R.child("commonDataList").child("status").set("CLOSE")}var L=t,T=e,R=n.getRooms().child(L),E={},V=[],P=[],W=[],N=null,x=null,U=null,j=null,J=null,Y=null,F=null,G=null,z=null;return function(){R.child("participantList").child(T).update({connected:!0,wasInsideRoom:!0}),R.child("participantList").child(T).child("connected").onDisconnect().set(!1),c()}(),{getRoomId:function(){return a()},getMe:function(){return s()},setOnParticipantJoin:function(e){u(e)},setOnParticipantLeave:function(e){f(e)},sendInstantMessage:function(e){return m(e)},setOnInstantMessage:function(e){b(e)},publishStream:function(e,t,n,o){return h(e,t,n,o)},setOnPublishedStream:function(e){v(e)},unPublishStream:function(e,t){return g(e,t)},setOnUnPublishedStream:function(e){p(e)},subscribeToStream:function(e,t,n){return S(e,t,n)},unSubscribeFromStream:function(e){return w(e)},getAvailableStreams:function(){return _()},getAvailableStream:function(e){return I(e)},muteAudioStream:function(e){K(e)},unmuteAudioStream:function(e){A(e)},muteVideoStream:function(e){C(e)},unmuteVideoStream:function(e){O(e)},close:function(e){return M(e)},on:function(e,t){switch(e){case"instantMessage":b(t);break;case"publishedStream":v(t);break;case"unPublishedStream":p(t);break;case"participantJoin":u(t);break;case"participantLeave":f(t);break;default:console.err("(webcomSDK::room["+L+"]::on)unsupported "+e+" event")}}}},e.exports=t["default"]},function(e,t,n){"use strict";var o=n(1)["default"];Object.defineProperty(t,"__esModule",{value:!0});var i=n(2),c=o(i),r=n(3),a=o(r),d=o(i),s="disconnected",l="connected",u="completed",f="checking",m="closed",b="failed",h={iceServers:[{url:"turns:turn1.webcom.orange.com:443",username:"admin",credential:"webcom1234"},{url:"turn:turn1.webcom.orange.com:3478",username:"admin",credential:"webcom1234"},{url:"turns:webcom1.orange-labs.fr:443",username:"admin",credential:"webcom1234"}]},v=function(e,t,n,o,i,r,v,g){function p(e){console.log("(webcomSDK::webrtc::)stackId="+V+"error="+e),console.dir(e)}function S(){console.log("(webcomSDK::webrtc::init_pc)stackId="+V+"_config=",JSON.stringify(B)),W=new H(B,{optional:[{DtlsSrtpKeyAgreement:!0}]}),W.onicecandidate=function(e){e.candidate&&(console.log("(webcomSDK::webrtc::pc.onicecandidate)stackId="+V+" send ice candidate="+JSON.stringify(e.candidate)),N.child("iceCandidatesList").push({label:e.candidate.sdpMLineIndex,id:e.candidate.sdpMid,candidate:e.candidate.candidate}))},W.onaddstream=function(e){console.debug("(webcomSDK::webrtc::onaddstream)stackId="+V+"-stream:"+JSON.stringify(e.stream)),e&&e.stream&&(ee=e.stream,re&&C(),ae&&M())},W.oniceconnectionstatechange=function(){if(W&&W.iceConnectionState===f)console.debug("(webcomSDK::webrtc::oniceconnectionstatechange)stackId="+V+"-checking"),ie=f;else if(W&&W.iceConnectionState===l){if(ie=l,console.debug("(webcomSDK::webrtc::oniceconnectionstatechange)stackId="+V+"-connected"),ee){for(var e=0;e<Z.length;e++)Z[e]&&(console.debug("(webcomSDK::webrtc::onaddstream)pc.onaddstream stackId="+V+"-rendering remote vid to "+Z[e].id),attachMediaStream(Z[e],ee));for(var t=0;t<$.length;t++)$[t]&&$[t](ee);$=[]}I()}else W&&W.iceConnectionState===u&&(ie=u,console.debug("(webcomSDK::webrtc::oniceconnectionstatechange)stackId="+V+"-"+u),I());W&&W.iceConnectionState===s?(ie=s,console.log("(webcomSDK::webrtc::oniceconnectionstatechange)stackId="+V+"-remote disconnection, closing peer connection"),A()):W&&W.iceConnectionState===m?(console.debug("(webcomSDK::webrtc::oniceconnectionstatechange)stackId="+V+"-closed"),ie=m,A()):W&&W.iceConnectionState===b?(console.debug("(webcomSDK::webrtc::oniceconnectionstatechange)stackId="+V+"-failed"),ie=b,A()):(W?console.debug("(webcomSDK::webrtc::oniceconnectionstatechange)stackId="+V+"-"+W.iceConnectionState):console.debug("(webcomSDK::webrtc::oniceconnectionstatechange)stackId="+V+"-pc = null"),ie="other"),!ne||ie!==s&&ie!==m&&ie!==b||(console.debug("(webcomSDK::webrtc::_close)stackId="+V+"-closed webrtc stack complete"),W=null,oe=!1,E.clearWebrtcStacks(G),F&&"function"==typeof F&&F(),ce&&"function"==typeof ce&&ce())},U=function(e){var t=e.val(),n=new Q({sdpMLineIndex:t.label,candidate:t.candidate,sdpMid:t.id});console.log("(webcomSDK::webrtc::iceCandidatesListCb)stackId="+V+"received ice candidate="+JSON.stringify(n)),W.addIceCandidate(n)},P?D(function(){y(),K()}):y()}function w(e,t){console.log("webcomSDK::webrtc::getIceServersConfigFromServer");var n;if(N){var o=N.root().child("config");o.once("value",function(o){o&&o.val()?(n=o.val(),"function"==typeof e&&e(n)):"function"==typeof t&&t()},function(e){"function"==typeof t&&t(e)})}else"function"==typeof t&&t()}function _(){x.child("iceCandidatesList").on("child_added",U)}function I(){x.child("iceCandidatesList").off("child_added",U)}function D(e){if(console.log("(webcomSDK::webrtc::_initlocalStream)stackId="+V+" get local video stream and renders to local video"),z){var t;z===d["default"].ACTION_TYPE_VIDEO?(t=function(){console.log("(webcomSDK::webrtc::_initlocalStream)initlocalStream_video"),te=a["default"].getVideoStream()&&a["default"].getVideoStream().clone&&"function"==typeof a["default"].getVideoStream().clone?a["default"].getVideoStream().clone():a["default"].getVideoStream(),re&&C(),ae&&M(),W.addStream(te);for(var t=0;t<X.length;t++)console.log("(webcomSDK::webrtc::_initlocalStream)stackId="+V+" rendering local video to "+X[t].id),attachMediaStream(X[t],a["default"].getVideoStream());e&&"function"==typeof e&&e()},a["default"].getVideoStream()?t():(a["default"].addVideoListener(t),a["default"].initVideo())):z===d["default"].ACTION_TYPE_AUDIO?(t=function(){console.log("(webcomSDK::webrtc::_initlocalStream)initlocalStream_audio"),te=a["default"].getAudioStream()&&a["default"].getAudioStream().clone&&"function"==typeof a["default"].getAudioStream().clone?a["default"].getAudioStream().clone():a["default"].getAudioStream(),re&&C(),ae&&M(),W.addStream(te);for(var t=0;t<X.length;t++)console.log("(webcomSDK::webrtc::_initlocalStream)stackId="+V+" rendering local Audio to "+X[t].id),attachMediaStream(X[t],a["default"].getAudioStream());e&&"function"==typeof e&&e()},a["default"].getAudioStream()?t():(a["default"].addAudioListener(t),a["default"].initAudio())):z===c["default"].ACTION_TYPE_AUDIO_VIDEO&&(t=function(){console.log("(webcomSDK::webrtc::_initlocalStream)initlocalStream_audio_video"),te=a["default"].getAudioVideoStream()&&a["default"].getAudioVideoStream().clone&&"function"==typeof a["default"].getAudioVideoStream().clone?a["default"].getAudioVideoStream().clone():a["default"].getAudioVideoStream(),re&&C(),ae&&M(),W.addStream(te);for(var t=0;t<X.length;t++)console.log("(webcomSDK::webrtc::_initlocalStream)stackId="+V+" rendering local AudioVideo to "+X[t].id),attachMediaStream(X[t],a["default"].getAudioVideoStream());e&&"function"==typeof e&&e()},a["default"].getAudioVideoStream()?t():(a["default"].addAudioVideoListener(t),a["default"].initAudioVideo()))}else console.warn("(webcomSDK::webrtc::_initlocalStream)no actionType specified")}function y(){console.debug("(webcomSDK::webrtc::_initSdpCallbacks)stackId="+V),P?(j&&x.off("child_added",j),J=function(e){if(!ne&&"sdpAnswer"===e.name()){var t=e.val();console.debug("(webcomSDK::webrtc::sdpAnswerCb)stackId="+V+"-received sdpAnswer: "+JSON.stringify(t)),W.setRemoteDescription(new q(t),function(){console.debug("(webcomSDK::webrtc::sdpAnswerCb)stackId="+V+"-remote description set"),_()},p),x.off("child_added",J)}},x.on("child_added",J)):(J&&x.off("child_added",J),j=function(e){if(!ne&&"sdpOffer"===e.name()){var t=e.val();console.debug("(webcomSDK::webrtc::sdpOfferCb)stackId="+V+"-received sdpOffer: "+JSON.stringify(t)),W.setRemoteDescription(new q(t),function(){W.createAnswer(function(e){console.log("(webcomSDK::webrtc::sdpOfferCb)stackId="+V+"-sending answer"),W.setLocalDescription(e,function(){console.debug("(webcomSDK::webrtc::sdpOfferCb)stackId="+V+"-set sdpAnswer in base : "+JSON.stringify(e)),N.child("sdpAnswer").set(JSON.parse(JSON.stringify(e))),_()},p)},p,{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}})},p),x.off("child_added",j)}},x.on("child_added",j))}function k(){J&&(x.off("child_added",J),J=null),j&&(x.off("child_added",j),j=null)}function K(){console.log("(webrtc::sendOffer)stackid="+V+"-creating sdpOffer"),W.createOffer(function(e){W.setLocalDescription(e,function(){console.debug("(webcomSDK::webrtc::createOffer)stackId="+V+"-set sdpOffer in base : "+JSON.stringify(e)),N.child("sdpOffer").set(JSON.parse(JSON.stringify(e)))},p)},p,{mandatory:{OfferToReceiveAudio:!1,OfferToReceiveVideo:!1}})}function A(e){if(oe||ne)console.debug("(webcomSDK::webrtc::_close)stackId="+V+"-closing webrtc stack already in progress");else{oe=!0,ce=e,console.debug("(webcomSDK::webrtc::_close)stackId="+V+"-closing webrtc stack"),W&&W.close(),Y&&(x.off("child_added",Y),Y=null),U&&(I(),U=null),k();for(var t=0;t<X.length;t++)X[t]&&(detachMediaStream(X[t]),console.debug("(webcomSDK::webrtc::_close)stackId="+V+"-stopping local video to "+X[t].id));for(var n=0;n<Z.length;n++)Z[n]&&(detachMediaStream(Z[n]),console.debug("(webcomSDK::webrtc::_close)stackId="+V+"-stopping remote vid to "+Z[n].id));ne=!0,console.debug("(webcomSDK::webrtc::_close)stackId="+V+"-closing webrtc stack -> waiting for ICE_CONNECTION_STATE_DISCONNECTED"),!ne||ie!==s&&ie!==m&&ie!==b||(console.debug("(webcomSDK::webrtc::_close)stackId="+V+"-closed webrtc stack complete"),W=null,oe=!1,E.clearWebrtcStacks(G),ce&&"function"==typeof ce&&ce())}}function C(){console.log("(webcomSDK::webrtc::_muteAudio)stackId="+V),re=!0;var e;if(P&&te){if(e=te.getAudioTracks(),e&&e.length>0)for(var t=0;t<e.length;t++)e[t]&&(e[t].enabled=!1)}else if(!P&&ee&&(e=ee.getAudioTracks(),e&&e.length>0))for(var n=0;n<e.length;n++)e[n]&&(e[n].enabled=!1)}function O(){console.log("(webcomSDK::webrtc::_unmuteAudio)stackId="+V),re=!1;var e;if(P&&te){if(e=te.getAudioTracks(),e&&e.length>0)for(var t=0;t<e.length;t++)e[t]&&(e[t].enabled=!0)}else if(!P&&ee&&(e=ee.getAudioTracks(),e&&e.length>0))for(var n=0;n<e.length;n++)e[n]&&(e[n].enabled=!0)}function M(){console.log("(webcomSDK::webrtc::_muteVideo)stackId="+V),ae=!0;var e;if(P&&te){if(e=te.getVideoTracks(),e&&e.length>0)for(var t=0;t<e.length;t++)e[t]&&(e[t].enabled=!1)}else if(!P&&ee&&(e=ee.getVideoTracks(),e&&e.length>0))for(var n=0;n<e.length;n++)e[n]&&(e[n].enabled=!1)}function L(){console.log("(webcomSDK::webrtc::_unmuteVideo)stackId="+V),ae=!1;var e;if(P&&te){if(e=te.getVideoTracks(),e&&e.length>0)for(var t=0;t<e.length;t++)e[t]&&(e[t].enabled=!0)}else if(!P&&ee&&(e=ee.getVideoTracks(),e&&e.length>0))for(var n=0;n<e.length;n++)e[n]&&(e[n].enabled=!0)}function T(e,t){z&&(z===c["default"].ACTION_TYPE_VIDEO?a["default"].connectLocalVideoStream(e,t):z===c["default"].ACTION_TYPE_AUDIO?a["default"].connectLocalAudioStream(e,t):z===c["default"].ACTION_TYPE_AUDIO_VIDEO&&a["default"].connectLocalAudioVideoStream(e,t))}function R(e,t){e?ee?(attachMediaStream(e,ee),t&&"function"==typeof t&&t(ee)):(Z.push(e),t&&"function"==typeof t&&$.push(t)):ee?t&&"function"==typeof t&&t(ee):t&&"function"==typeof t&&$.push(t)}var E=e,V=(new Date).getTime(),P=t,W=null,N=n,x=o,U=null,j=null,J=null,Y=null,F=null,G=i,z=r,B=null,H=null,q=null,Q=null,X=[],Z=[],$=[],ee=null,te=null,ne=!1,oe=!1,ie=null,ce=null,re=!1,ae=!1;return console.log("(webcomSDK::webrtc::)stackId="+V+" isPublish="+P+",localDataRef="+N+",remoteDataRef="+x+")"),function(){if(console.log("(webcomSDK::webrtc::init)stackId="+V),"function"!=typeof RTCPeerConnection)throw console.error("(webcomSDK::webrtc::init)stackId="+V+" error=Webrtc is not supported on this browser !"),new Error("Webrtc is not supported on this browser !");if(H=RTCPeerConnection,"function"!=typeof RTCSessionDescription)throw console.error("(webcomSDK::webrtc::init)stackId="+V+" error2=Webrtc is not supported on this browser !"),new Error("Webrtc is not supported on this browser !");if(q=RTCSessionDescription,"function"!=typeof RTCIceCandidate)throw console.error("(webcomSDK::webrtc::init)stackId="+V+" error3=Webrtc is not supported on this browser !"),new Error("Webrtc is not supported on this browser !");Q=RTCIceCandidate,v&&(re=!0),g&&(ae=!0),w(function(e){B=e,console.log("(webcomSDK::webrtc::) use server config=",JSON.stringify(B)),S()},function(){"undefined"!=typeof h?(B=h,console.log("(webcomSDK::webrtc::) use DEFAULT_ICE_CONFIG config=",JSON.stringify(B))):console.log("(webcomSDK::webrtc::) no ice  config"),S()})}(),{setOnClose:function(e){F=e},close:function(e){console.debug("(webcomSDK::webrtc::_close)stackId="+V+"-close requested"),A(e)},connectLocalStream:function(e,t){T(e,t)},connectRemoteStream:function(e,t){R(e,t)},muteAudio:function(){C()},unmuteAudio:function(){O()},muteVideo:function(){M()},unmuteVideo:function(){L()}}};t["default"]=v,e.exports=t["default"]},function(e,t,n){"use strict";var o=n(1)["default"];Object.defineProperty(t,"__esModule",{value:!0});var i=n(4),c=o(i),r=n(11),a=o(r),d=n(3),s=o(d),l=function(e){function t(t,n,o,i,r,d,s,l,m,b){var h,v=d,g=e.getWebrtc().child(s).child(c["default"].appInstanceId),p=e.getWebrtc().child(s).child(n);h=i?{webRtcStackId:v,localVid:t}:{webRtcStackId:v,remoteVid:t};var S=f.push(h)-1;if(u[v])console.debug("webcomSDK::webrtcmngr::createWebrtc->use existing real webrtcStack"),i?(u[v].isPublished++,u[v].stack.connectLocalStream(t,b)):(u[v].isSubscribed++,u[v].stack.connectRemoteStream(t,b));else{console.debug("webcomSDK::webrtcmngr::createWebrtc->create a new real webrtcStack");var w;w=a["default"](this,i,g,p,v,r,l,m),w.setOnClose(o),i?(u[v]={stack:w,isPublished:1,isSubscribed:0},w.connectLocalStream(t,b)):(u[v]={stack:w,isPublished:0,isSubscribed:1},w.connectRemoteStream(t,b))}return console.debug("webcomSDK::webrtcmngr::createWebrtc->webrtcStack:"+v+" new isPublished count ="+u[v].isPublished+" new isSubscribed count ="+u[v].isSubscribed),S}function n(e,t,n){if(console.debug("webcomSDK::webrtcmngr::closeWebrtc->id="+e),!f[e])return console.warn("webcomSDK::webrtcmngr::closeWebrtc: virtualstack "+e+" not found"),n&&"function"==typeof n&&n(),!1;var o=f[e].webRtcStackId;return o&&u[o]?(t&&u[o].isPublished>0?u[o].isPublished--:!t&&u[o].isSubscribed>0&&u[o].isSubscribed--,u[o].isPublished<1&&u[o].isSubscribed<1?(console.debug("webcomSDK::webrtcmngr::closeWebrtc->destroy  real webrtcStack:"+o),u[o].stack.close(n),u[o]=null):(console.debug("webcomSDK::webrtcmngr::closeWebrtc->decrement  real webrtcStack:"+o+" new isPublished count ="+u[o].isPublished+" new isSubscribed count ="+u[o].isSubscribed),n&&"function"==typeof n&&n())):(n&&"function"==typeof n&&n(),console.warn("webcomSDK::webrtcmngr::closeWebrtc cannot found real stack")),f[e].localVid&&(s["default"].close(),detachMediaStream(f[e].localVid)),f[e].remoteVid&&detachMediaStream(f[e].remoteVid),!0}function o(e){return console.debug("webcomSDK::webrtcmngr::clearWebrtcStacks id="+e),e&&u&&u[e]&&(u[e]=null),!0}function i(e){if(console.log("(webcomSDK::webrtcmngr::muteAudioWebrtcStack) virtualWebrtcStackId="+e),f&&f[e]&&f[e].webRtcStackId){var t=f[e].webRtcStackId;console.log("(webcomSDK::webrtcmngr::muteAudioWebrtcStack) virtualWebrtcStackId="+e+"webRtcStackId="+t),u&&u[t]&&u[t].stack?u[t].stack.muteAudio():console.warn("(webcomSDK::webrtcmngr::muteAudioWebrtcStack) webrtcStack="+t+"not found")}else console.warn("(webcomSDK::webrtcmngr::muteAudioWebrtcStack) virtualWebrtcStackId="+e+"not found")}function r(e){if(console.log("(webcomSDK::webrtcmngr::_unmuteAudioWebrtcStack) virtualWebrtcStackId="+e),f&&f[e]&&f[e].webRtcStackId){var t=f[e].webRtcStackId;console.log("(webcomSDK::webrtcmngr::_unmuteAudioWebrtcStack) virtualWebrtcStackId="+e+",webRtcStackId="+t),u&&u[t]&&u[t].stack?u[t].stack.unmuteAudio():console.warn("(webcomSDK::webrtcmngr::_unmuteAudioWebrtcStack) webrtcStack="+t+"not found")}else console.warn("(webcomSDK::webrtcmngr::_unmuteAudioWebrtcStack) virtualWebrtcStackId="+e+"not found")}function d(e){if(console.log("(webcomSDK::webrtcmngr::muteAudioWebrtcStack) virtualWebrtcStackId="+e),f&&f[e]&&f[e].webRtcStackId){var t=f[e].webRtcStackId;console.log("(webcomSDK::webrtcmngr::muteAudioWebrtcStack) virtualWebrtcStackId="+e+"webRtcStackId="+t),u&&u[t]&&u[t].stack?u[t].stack.muteVideo():console.warn("(webcomSDK::webrtcmngr::muteAudioWebrtcStack) webrtcStack="+t+"not found")}else console.warn("(webcomSDK::webrtcmngr::muteAudioWebrtcStack) virtualWebrtcStackId="+e+"not found")}function l(e){if(console.log("(webcomSDK::webrtcmngr::_unmuteAudioWebrtcStack) virtualWebrtcStackId="+e),f&&f[e]&&f[e].webRtcStackId){var t=f[e].webRtcStackId;console.log("(webcomSDK::webrtcmngr::_unmuteAudioWebrtcStack) virtualWebrtcStackId="+e+",webRtcStackId="+t),u&&u[t]&&u[t].stack?u[t].stack.unmuteVideo():console.warn("(webcomSDK::webrtcmngr::_unmuteAudioWebrtcStack) webrtcStack="+t+"not found")}else console.warn("(webcomSDK::webrtcmngr::_unmuteAudioWebrtcStack) virtualWebrtcStackId="+e+"not found")}var u=[],f=[];return{createWebrtc:function(e,n,o,i,c,r,a,d,s){return t.bind(this)(e,n,o,i,c,r,a,d,s)},closeWebrtc:function(e,t,o){return n(e,t,o)},clearWebrtcStacks:function(e){return o(e)},muteAudioWebrtcStack:function(e){return i(e)},unmuteAudioWebrtcStack:function(e){return r(e)},muteVideoWebrtcStack:function(e){return d(e)},unmuteVideoWebrtcStack:function(e){return l(e)}}};t["default"]=l,e.exports=t["default"]},function(e,t,n){e.exports={"default":n(16),__esModule:!0}},function(e,t){"use strict";t["default"]=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},t.__esModule=!0},function(e,t,n){"use strict";var o=n(13)["default"];t["default"]=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),o(e,i.key,i)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),t.__esModule=!0},function(e,t,n){var o=n(22);e.exports=function(e,t,n){return o.setDesc(e,t,n)}},function(e,t,n){n(25),e.exports=n(5).Object.keys},function(e,t,n){var o=n(21),i=n(5),c="prototype",r=function(e,t){return function(){return e.apply(t,arguments)}},a=function(e,t,n){var d,s,l,u,f=e&a.G,m=e&a.P,b=f?o:e&a.S?o[t]:(o[t]||{})[c],h=f?i:i[t]||(i[t]={});f&&(n=t);for(d in n)s=!(e&a.F)&&b&&d in b,s&&d in h||(l=s?b[d]:n[d],f&&"function"!=typeof b[d]?u=n[d]:e&a.B&&s?u=r(l,o):e&a.W&&b[d]==l?!function(e){u=function(t){return this instanceof e?new e(t):e(t)},u[c]=e[c]}(l):u=m&&"function"==typeof l?r(Function.call,l):l,h[d]=u,m&&((h[c]||(h[c]={}))[d]=l))};a.F=1,a.G=2,a.S=4,a.P=8,a.B=16,a.W=32,e.exports=a},function(e,t){e.exports=function(e){if(void 0==e)throw TypeError("Can't call method on  "+e);return e}},function(e,t){e.exports=function(e){try{return!!e()}catch(t){return!0}}},function(e,t){var n="undefined",o=e.exports=typeof window!=n&&window.Math==Math?window:typeof self!=n&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=o)},function(e,t){var n=Object;e.exports={create:n.create,getProto:n.getPrototypeOf,isEnum:{}.propertyIsEnumerable,getDesc:n.getOwnPropertyDescriptor,setDesc:n.defineProperty,setDescs:n.defineProperties,getKeys:n.keys,getNames:n.getOwnPropertyNames,getSymbols:n.getOwnPropertySymbols,each:[].forEach}},function(e,t,n){e.exports=function(e,t){var o=n(18),i=(n(5).Object||{})[e]||Object[e],c={};c[e]=t(i),o(o.S+o.F*n(20)(function(){i(1)}),"Object",c)}},function(e,t,n){var o=n(19);e.exports=function(e){return Object(o(e))}},function(e,t,n){var o=n(24);n(23)("keys",function(e){return function(t){return e(o(t))}})}])});